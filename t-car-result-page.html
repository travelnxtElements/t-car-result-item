<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../t-sessionstorage/t-sessionstorage.html">
<link rel="import" href="../t-list/t-list.html">
<link rel="import" href="../t-notify/t-notify.html">
<link rel="import" href="t-car-result-item.html">
<link rel="import" href="../t-notify/t-notify.html">
<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->
<dom-module id="t-car-result-page">
    <template>
        <style>
        :host {
            display: block;
        }
        </style>

        <t-notify id="notify"></t-notify>

        <content select="t-header"></content>

        <t-list
            id="list"
            filter-api="[[apiBaseUrl]]api/car/filter/[[searchId]]/rates?token=[[authToken]]"
            filter-results-api="[[apiBaseUrl]]api/car/results/filter/[[searchId]]/rates?token=[[authToken]]&$select=Name,Category,Capacity,Baggage,AirConditioning,Transmission,Doors,HeroImageUrl,IsPostPaid,Source,Id,Fare,PickupInfo,DropoffInfo,Brand,Mileage,GeneralPolicies,OptionalEquipment"
            with-filter
            update-filters
            search-icon="[[searchIcon]]" 
            filter-icon="[[filterIcon]]" 
            token-param="inventories"
            redirect-link="[[redirectLink]]"
            currency="[[currency]]">
            <template>
            <div>
                <t-car-result-item 
                    itinerary=[[item]]
                    price=[[minPrice]]
                    currency="[[currency]]"
                    book-period="2">
                </t-car-result-item>
            </div>
            </template>
        </t-list>

        <t-sessionstorage
            id="sessionStore"
            key="Car_Result_Data"
            api-url-format="[[apiUrlFormat]]"
            on-t-sessionstorage-load-success="_onSessionLoad">
        </t-sessionstorage>
    </template>    
    <script>

        (function () {

            'use strict'

            var filterPayload = {
                category: "Category",
                group: "Category",
                label: "",
                name: "",
                type: "Options"
            };

            Polymer({

                is: 't-car-result-page',

                properties: {

                    visible: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    selectedCategory: {
                        type: String
                    },

                    minPrice: {
                        type: String
                    },

                    /*
                     * <p>This string is query string containing token value</p>
                    */
                    authToken: {
                        type: String
                    },

                    /*
                     * <p>This string is query string containing token value</p>
                    */
                    searchId: {
                        type: String
                    },

                    /*
                     * <p>This property holds the value of api base URL</p>
                    */
                    apiBaseUrl: {
                        type: String
                    },

                    /*
                     * <p>This property holds the value of web api URL format</p>
                    */
                    apiUrlFormat: {
                        type: String
                    },

                    itinerary: {
                        type: Object,
                        notify: true
                    },


                    itineraryId: {
                        type: String,
                        notify: true
                    },

                    currency: {
                        type: String,
                        value: 'USD'
                    },

                    redirectLink: {
                        type: String
                    },

                    list: {
                        type: Array,
                        value: []
                    }
                },

                observers: [
                    '_visibleChange(visible)',
                    '_updateCarResults(authToken, selectedCategory, searchId)'
                ],

                listeners: {
                    'book-car-itinerary': '_onBookItinerary'
                },

                _visibleChange: function (visible) {
                    if (visible && (!this.selectedCategory || !this.minPrice || !this.authToken || !this.searchId)) {
                        this.fire('go-to-search');
                    }
                },

                _updateCarResults: function (authToken, selectedCategory, searchId) {
                    if (!selectedCategory || !this.minPrice || !authToken || !searchId) {
                        return;
                    }

                    filterPayload.name = selectedCategory;
                    filterPayload.label = selectedCategory;

                    this.$.list.sortParams = [{
                        key: "Price",
                        value: "$orderby=MinFare/Fare/Amount",
                        default: true
                    }];

                    this.$.list.includeFilters = [
                        "Price",
                        "Location",
                        "Brand",
                        "Features"
                    ];

                    this.$.list.defaultFilters = [filterPayload];
                    this.$.list.onApplyFilters([filterPayload]);
                    this.$.list.$.filter.generateFilter();
                },

                _onBookItinerary: function (e) {
                    if (e && e.detail) {

                        this.itinerary = e.detail;
                        this.itineraryId = e.detail.id;

                        this.fire('car-select');
                        this.$.sessionStore.value = this.itinerary;
                        this.$.sessionStore.save();
                    }
                },

                _onSessionLoad: function () {
                    if (this.$.sessionStore.value) {
                        this.itinerary = this.$.sessionStore.value.itinerary;
                    }
                }
            });

        })();
    </script>
</dom-module>
